language: go
go:
- '1.8'
sudo: true
before_install:
- sudo add-apt-repository ppa:masterminds/glide -y
- sudo apt-get update -q
- sudo apt-get install glide -y
install:
- glide install
- go get github.com/mjibson/esc
- go get github.com/ahmetb/govvv
- go get github.com/franciscocpg/gox
- go get github.com/tcnksm/ghr
- go get github.com/sanbornm/go-selfupdate
script:
- cd ${TRAVIS_BUILD_DIR}/cmd && go generate && cd ${TRAVIS_BUILD_DIR}
- VERSION=$(cat ./VERSION)
- echo "VERSION = ${VERSION}"
- DIST=${TRAVIS_BUILD_DIR}/dist/raid/stable

- CGO_ENABLED=0 gox -verbose  -os="linux darwin windows" -arch="amd64 386 armv5 armv6 armv7 arm64" -osarch="!darwin/arm64 linux/ppc64 linux/ppc64le" -ldflags="$(govvv -flags) -s -w -X github.com/rai-project/raid/cmd.appsecret=\"${APP_SECRET}\" -extldflags \"-static\"" -output="${DIST}/${VERSION}/{{.OS}}-{{.Arch}}/{{.Dir}}" .
before_deploy:
- echo "go-selfupdate generating bindiffs"
- mkdir -p ${DIST}/${VERSION}/binaries
- mkdir -p ${DIST}/latest
- tar --transform 's/.*\///g' -czvf ${DIST}/${VERSION}/binaries/darwin-386     ${DIST}/${VERSION}/darwin-386/raid        ${TRAVIS_BUILD_DIR}/LICENSE.TXT
  ${TRAVIS_BUILD_DIR}/VERSION
- tar --transform 's/.*\///g' -czvf ${DIST}/${VERSION}/binaries/darwin-amd64   ${DIST}/${VERSION}/darwin-amd64/raid      ${TRAVIS_BUILD_DIR}/LICENSE.TXT
  ${TRAVIS_BUILD_DIR}/VERSION
- tar --transform 's/.*\///g' -czvf ${DIST}/${VERSION}/binaries/linux-386      ${DIST}/${VERSION}/linux-386/raid         ${TRAVIS_BUILD_DIR}/LICENSE.TXT
  ${TRAVIS_BUILD_DIR}/VERSION
- tar --transform 's/.*\///g' -czvf ${DIST}/${VERSION}/binaries/linux-amd64    ${DIST}/${VERSION}/linux-amd64/raid       ${TRAVIS_BUILD_DIR}/LICENSE.TXT
  ${TRAVIS_BUILD_DIR}/VERSION
- tar --transform 's/.*\///g' -czvf ${DIST}/${VERSION}/binaries/linux-armv5    ${DIST}/${VERSION}/linux-armv5/raid       ${TRAVIS_BUILD_DIR}/LICENSE.TXT
  ${TRAVIS_BUILD_DIR}/VERSION
- tar --transform 's/.*\///g' -czvf ${DIST}/${VERSION}/binaries/linux-armv6    ${DIST}/${VERSION}/linux-armv6/raid       ${TRAVIS_BUILD_DIR}/LICENSE.TXT
  ${TRAVIS_BUILD_DIR}/VERSION
- tar --transform 's/.*\///g' -czvf ${DIST}/${VERSION}/binaries/linux-armv7    ${DIST}/${VERSION}/linux-armv7/raid       ${TRAVIS_BUILD_DIR}/LICENSE.TXT
  ${TRAVIS_BUILD_DIR}/VERSION
- tar --transform 's/.*\///g' -czvf ${DIST}/${VERSION}/binaries/linux-arm64    ${DIST}/${VERSION}/linux-arm64/raid       ${TRAVIS_BUILD_DIR}/LICENSE.TXT
  ${TRAVIS_BUILD_DIR}/VERSION
- tar --transform 's/.*\///g' -czvf ${DIST}/${VERSION}/binaries/linux-ppc64    ${DIST}/${VERSION}/linux-ppc64/raid       ${TRAVIS_BUILD_DIR}/LICENSE.TXT
  ${TRAVIS_BUILD_DIR}/VERSION
- tar --transform 's/.*\///g' -czvf ${DIST}/${VERSION}/binaries/linux-ppc64le  ${DIST}/${VERSION}/linux-ppc64le/raid     ${TRAVIS_BUILD_DIR}/LICENSE.TXT
  ${TRAVIS_BUILD_DIR}/VERSION
- tar --transform 's/.*\///g' -czvf ${DIST}/${VERSION}/binaries/windows-386    ${DIST}/${VERSION}/windows-386/raid.exe   ${TRAVIS_BUILD_DIR}/LICENSE.TXT
  ${TRAVIS_BUILD_DIR}/VERSION
- tar --transform 's/.*\///g' -czvf ${DIST}/${VERSION}/binaries/windows-amd64  ${DIST}/${VERSION}/windows-amd64/raid.exe
  ${TRAVIS_BUILD_DIR}/LICENSE.TXT ${TRAVIS_BUILD_DIR}/VERSION
- go-selfupdate -o ${DIST}/updates ${DIST}/${VERSION}/binaries/ ${VERSION}
- cp ${DIST}/${VERSION}/binaries/darwin-386    ${DIST}/latest/darwin-386.tar.gz
- cp ${DIST}/${VERSION}/binaries/darwin-amd64  ${DIST}/latest/darwin-amd64.tar.gz
- cp ${DIST}/${VERSION}/binaries/linux-386     ${DIST}/latest/linux-386.tar.gz
- cp ${DIST}/${VERSION}/binaries/linux-amd64   ${DIST}/latest/linux-amd64.tar.gz
- cp ${DIST}/${VERSION}/binaries/linux-armv5   ${DIST}/latest/linux-armv5.tar.gz
- cp ${DIST}/${VERSION}/binaries/linux-armv6   ${DIST}/latest/linux-armv6.tar.gz
- cp ${DIST}/${VERSION}/binaries/linux-armv7   ${DIST}/latest/linux-armv7.tar.gz
- cp ${DIST}/${VERSION}/binaries/linux-arm64   ${DIST}/latest/linux-arm64.tar.gz
- cp ${DIST}/${VERSION}/binaries/linux-ppc64   ${DIST}/latest/linux-ppc64.tar.gz
- cp ${DIST}/${VERSION}/binaries/linux-ppc64le ${DIST}/latest/linux-ppc64le.tar.gz
- cp ${DIST}/${VERSION}/binaries/windows-386   ${DIST}/latest/windows-386.tar.gz
- cp ${DIST}/${VERSION}/binaries/windows-amd64 ${DIST}/latest/windows-amd64.tar.gz
- rm -fr ${DIST}/${VERSION}/binaries
- echo "Copying latest directory to ${DIST}/${TRAVIS_COMMIT}"
- cp -r ${DIST}/latest ${DIST}/${TRAVIS_COMMIT}
deploy:
  provider: s3
  access_key_id: AKIAIAFSJLCCOYB5V3EQ
  secret_access_key:
    secure: ttpg/QvD7TcPUw7tqoluO/Wa7Q+tCEfqefbZfbnGMp1gZOawn9rk8cH2KQ6/2z9bXaK24hOw8ixqk/rn7LhJ1b5NxODogJaONhphs7sDIfDarieyNMwjLtgfvQruX04cxacYq8GqTP1hG+9AgXgpJiDkYmixfPrzfUuvc2DKM/DfEk0gywDdNEoTkgsPvsC0aTCZF2fBi1vxmpUFqk3oQTRmYFJeBJ/L28gxQuXjQk0ymL7rk428S9hQw5BRtRNJhdnozUXse3uGVG2UbG+m7KGTmCScb+8At3SaeVqHSzzFupWgcWCCJyBlpqXX0RzKiW3/sXeM1ryuyfJ68a7pPUEQuuwOWEcYX9HgnFjRWc7lS47serYIkaFMhp0EYJGP1eWF9hm78LP9C6nMTU/Dr0Hk0xnSX5Gv7sIn0wx0NovV78ofsSBvUxvln8V1cng9cIgFSuxAgQqfGaaeUg4JKZSb9hxhXs6Xh8Ya+LOuS7CJCPQ+VqNuvhl4Hg/0Hi3S/zpsO+PEJoUfnJPohIDxQbFMiqW21Py4taJK0kVRFOJgxyx7o2Kvp9w8GIV6obZVFXfbG7t2RzXc1n8L5O2uo4SDCOGDLFuFeROpzE/UwdCoKQVHQspjGc+ysOOqeULT/OzwD0v9NsRVrC63qISgzEQ6hkjY/NzS3DjQzmZeINM=
  bucket: files.rai-project.com
  local-dir: dist
  upload-dir: dist
  acl: private
  skip_cleanup: true
  detect_encoding: true
  on:
    repo: rai-project/raid
env:
  global:
  - secure: C1knBNPjo+kdi0H5lmHW4/X9pAO0J99s5W04bs7G9A/3yTFtYTl6Qn/VYotGWxoLnaV2LYxyOzCaBg/qASvNTYAZvTxT6uwW7FSPLBdbgN8eaRl16hvvUSvBIBWULFYGvd0FGqXuf/IsDjcHMDpcOIm6H4VcpzugN/zSOb9/koq5oVWbioxhRPPia5N0d8sXniyCHS2lj3rFasg4jEgxspBgG5j9rHX34d6dAwZZTzGh07EQoELU6LmjBiphvajZBxsvqzKXFmnS4zYFVezgxIS8XxG3RfyN1vIina7hl8VURcapTKBp307jvkI6aPBTAOFtrHE5RexvPTPl5+H0r1Fw1wMeWwMWTG9NLtGx+wBb/Xk++W+EiNx2lwIpey+ozLfQE7nw9czdHilNOe1fu9Dfh5CyCGML7mlWzezY5QU/p58HWCggaCuwD0SBeD6Z+hqvMRn+iTUmPG4yHiLgf7jhYSjW+h2VGXgMw/uO7ZWrKG5/sOQ6wHIq9H6r42ns5Lf9FZ7c4Ly1CjKsmRmQMqLVHZuWY0yN6AlvKty24sXIk9Ab4XSjF89J4QYdKD9XbTInQJblbCYisbfmE3rBKOVBdo/4tD+b82jCWrINmR/+CMEPN3aNCob9IhraKKi95+Z1FICQPRN9qUJw4+x4OxqhjegxVSecpFDId2uEtZM=
  - secure: G7oVWOfDrWdJMwJM6m2JWlEyDq+wxp4vkq+kcpmZLDHLMoXdJSZPTcwhpZu0kb+LxBeYhTAHzIK5xY4BReCu3eHyCSH6qF/KBoQuyiN97pHtvs3Oy69odvhuWxJNW0mX7UsJOmt1ZN+FK4Huc7YjL+JHl4DYsrx2lh2dxiYuvY3QldGYJcXIsJm3wzIfku9x53VsoVGlHAbZrMqgFp0jZ1dn5J12nI4iqh09DJIalzZ1dlNyyuBAHr4OiCmmKlYiljQcIU7i9Z9Q8ffNamr6rnkapOQD7WLdz1g0JDUn/AsNrXSP7yranes7iXN0yk+im997+f5yIsqwv/6IAcwe5gg9YIv6A8FckZP2ICXjyMS3U3WYCbZhFT/1S3Zf0odH/PzMQbuz3VhD+rEMXryBAg+uIooFX7Un1dr+kqEzNFP9mKGsL1IYFghII4m3YwGeq6l+OpZQ/fI3joBSe1a9QGBothInBEVXXnSaK21Hbm9rTP6+eWVLAgnejFMFceGXYjOUfdX8z1n9NllSWefkWCj9VrB8GFFpe6f3veuByfHjIvLygudHax8T4EeCpF1EYzzNu6Cy28Ga4bVX+wUgZkI7sMydySuY1jMTJM7wjSLf7h7/h1wnBd+9t4WDesaFmzWQtELLzWsGWq+jKrDrOw4FqPxW9JbI0wM8ymfqNpY=
